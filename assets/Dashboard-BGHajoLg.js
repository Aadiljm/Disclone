import{r,j as e}from"./index-mksmxrp2.js";const T="DiscloneDB",h="messages",V=1,M=()=>new Promise((t,a)=>{const c=indexedDB.open(T,V);c.onerror=o=>a(o.target.error),c.onupgradeneeded=o=>{const i=o.target.result;i.objectStoreNames.contains(h)||i.createObjectStore(h,{keyPath:"id"})},c.onsuccess=o=>t(o.target.result)}),b=async t=>{const a=await M();return new Promise((c,o)=>{const d=a.transaction([h],"readwrite").objectStore(h).add(t);d.onsuccess=()=>c(d.result),d.onerror=g=>o(g.target.error)})},F=async()=>{const t=await M();return new Promise((a,c)=>{const l=t.transaction([h],"readonly").objectStore(h).getAll();l.onsuccess=()=>a(l.result),l.onerror=d=>c(d.target.error)})},W=({msg:t})=>{const[a,c]=r.useState(null);r.useEffect(()=>{if(t.type==="video"||t.type==="voice"||t.type==="image"){const i=URL.createObjectURL(t.content);return c(i),()=>URL.revokeObjectURL(i)}},[t]);const o=i=>new Date(i).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return e.jsxs("div",{className:"message-item",children:[e.jsx("div",{className:"avatar"}),e.jsxs("div",{className:"message-content",children:[e.jsxs("div",{className:"message-header",children:[e.jsx("span",{className:"username",children:"User"}),e.jsx("span",{className:"timestamp",children:o(t.timestamp)})]}),t.type==="text"&&e.jsx("div",{className:"text-content",children:t.content}),t.type==="video"&&a&&e.jsx("div",{className:"media-content",children:e.jsx("video",{controls:!0,src:a})}),t.type==="image"&&a&&e.jsx("div",{className:"media-content",children:e.jsx("img",{src:a,alt:"uploaded content",style:{maxWidth:"100%",borderRadius:"8px"}})}),t.type==="voice"&&a&&e.jsx("div",{className:"media-content",children:e.jsx("audio",{controls:!0,src:a})})]})]})};function H({onClose:t}){const[a,c]=r.useState([]),[o,i]=r.useState(""),[l,d]=r.useState(!1),[g,v]=r.useState(!1),N=r.useRef(null),R=r.useRef(null),f=r.useRef(null),y=r.useRef([]),w=r.useCallback(()=>{N.current?.scrollIntoView({behavior:"smooth"})},[]),x=r.useCallback(async()=>{try{const s=await F();s.sort((n,u)=>n.timestamp-u.timestamp),c(s)}catch(s){console.error("Failed to load messages",s)}},[]);r.useEffect(()=>{x()},[x]),r.useEffect(()=>{w()},[a,w]);const S=async()=>{if(!o.trim())return;const s={id:crypto.randomUUID(),type:"text",content:o,timestamp:Date.now()};try{await b(s),i(""),x()}catch(n){console.error("Failed to send text",n)}},D=s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),S())},C=async s=>{const n=s.target.files[0];if(!n)return;const u=n.type.startsWith("video/"),p=n.type.startsWith("image/");if(!u&&!p){alert("Only video and image files are supported.");return}const m={id:crypto.randomUUID(),type:u?"video":"image",content:n,timestamp:Date.now()};try{await b(m),x()}catch(j){console.error("Failed to upload file",j)}s.target.value=null},k=async()=>{try{const s=await navigator.mediaDevices.getUserMedia({audio:!0});let n="";typeof MediaRecorder.isTypeSupported=="function"&&(MediaRecorder.isTypeSupported("audio/webm;codecs=opus")?n="audio/webm;codecs=opus":MediaRecorder.isTypeSupported("audio/mp4")?n="audio/mp4":MediaRecorder.isTypeSupported("audio/webm")&&(n="audio/webm"));const u=n?{mimeType:n}:void 0,p=new MediaRecorder(s,u);f.current=p,y.current=[],p.ondataavailable=m=>{m.data.size>0&&y.current.push(m.data)},p.onstop=async()=>{const m=p.mimeType||n||"audio/webm",j=new Blob(y.current,{type:m}),B={id:crypto.randomUUID(),type:"voice",content:j,timestamp:Date.now()};await b(B),x(),s.getTracks().forEach(I=>I.stop())},p.start(),d(!0)}catch(s){console.error("Failed to access microphone",s),alert("Could not access microphone.")}},E=()=>{f.current&&l&&(f.current.stop(),d(!1))},U=()=>{l?E():k()};return e.jsxs("div",{className:"app-container",children:[e.jsx("div",{className:`mobile-overlay ${g?"open":""}`,onClick:()=>v(!1)}),e.jsxs("div",{className:`sidebar-wrapper ${g?"open":""}`,children:[e.jsxs("nav",{className:"server-sidebar",children:[e.jsx("div",{className:"server-icon active",children:"D"}),e.jsx("div",{className:"server-divider"}),e.jsx("div",{className:"server-icon"}),e.jsx("div",{className:"server-icon"})]}),e.jsxs("div",{className:"channel-sidebar",children:[e.jsx("header",{className:"chat-header",style:{boxShadow:"none"},children:e.jsx("span",{style:{fontWeight:"bold"},children:"Disclone Server"})}),e.jsx("div",{style:{flex:1,padding:"8px",overflowY:"auto"},children:e.jsxs("div",{style:{display:"flex",alignItems:"center",padding:"6px 8px",borderRadius:"4px",background:"rgba(255,255,255,0.08)",marginBottom:"4px",color:"#fff",cursor:"pointer"},onClick:()=>v(!1),children:[e.jsx("span",{style:{color:"#80848E",marginRight:"6px",fontSize:"20px"},children:"#"}),e.jsx("span",{style:{fontWeight:500},children:"general"})]})}),e.jsxs("div",{style:{backgroundColor:"#232428",padding:"10px 8px",display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsx("div",{style:{width:"32px",height:"32px",borderRadius:"50%",background:"#F0B132"}}),e.jsxs("div",{style:{display:"flex",flexDirection:"column"},children:[e.jsx("span",{style:{fontSize:"14px",fontWeight:"600",lineHeight:"18px"},children:"Guest"}),e.jsx("span",{style:{fontSize:"12px",color:"#DBDEE1"},children:"#9999"})]})]}),e.jsx("button",{onClick:t,title:"Fully Close Website",style:{background:"#ED4245",border:"none",color:"white",width:"32px",height:"32px",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",fontWeight:"bold"},children:"✕"})]})]})]}),e.jsxs("main",{className:"chat-area",children:[e.jsxs("header",{className:"chat-header",children:[e.jsx("button",{className:"menu-btn",onClick:()=>v(!0),"aria-label":"Open Menu",children:e.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M3 8V6H21V8H3ZM3 13H21V11H3V13ZM3 18H21V16H3V18Z"})})}),e.jsx("span",{style:{fontSize:"24px",color:"#80848E",marginRight:"8px",fontWeight:300},children:"#"}),e.jsx("span",{style:{fontWeight:"bold",color:"#F2F3F5"},children:"general"}),e.jsx("button",{className:"mobile-close-btn",onClick:t,title:"Close Session",children:"✕"})]}),e.jsxs("div",{className:"message-list",children:[e.jsxs("div",{className:"message-item",children:[e.jsx("div",{className:"avatar",style:{background:"#5865F2"}}),e.jsxs("div",{className:"message-content",children:[e.jsx("div",{className:"message-header",children:e.jsx("span",{className:"username",children:"System"})}),e.jsx("div",{className:"text-content",children:"Welcome to your secure Disclone instance. Messages are saved locally."})]})]}),a.map(s=>e.jsx(W,{msg:s},s.id)),e.jsx("div",{ref:N})]}),e.jsxs("div",{className:"chat-input-container",children:[e.jsx("input",{type:"file",accept:"video/*,image/*",style:{display:"none"},ref:R,onChange:C}),e.jsx("button",{className:"icon-btn",onClick:()=>R.current.click(),title:"Upload File",children:e.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"})})}),e.jsx("input",{type:"text",className:"chat-input",placeholder:"Message #general",value:o,onChange:s=>i(s.target.value),onKeyDown:D}),e.jsx("button",{className:`icon-btn ${l?"recording":""}`,onClick:U,title:l?"Stop Recording":"Record Voice Message",children:e.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:[e.jsx("path",{d:"M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"}),e.jsx("path",{d:"M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"})]})})]})]})]})}export{H as default};
