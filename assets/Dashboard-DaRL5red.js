import{r as a,g as L,a as _,b as K,j as e,f as Z,s as O,c as Y,d as N,A as G}from"./index-CQCrDPy-.js";const J=({msg:i,isOwnMessage:t})=>{const m=G,d=i.fileUrl?`${m}${i.fileUrl}`:null,p=f=>new Date(f).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return e.jsxs("div",{className:`message-item ${t?"own-message":""}`,style:{flexDirection:t?"row-reverse":"row"},children:[e.jsx("div",{className:"avatar",style:{background:t?"#5865F2":"#7289da"}}),e.jsxs("div",{className:"message-content",style:{alignItems:t?"flex-end":"flex-start"},children:[e.jsxs("div",{className:"message-header",style:{flexDirection:t?"row-reverse":"row"},children:[e.jsx("span",{className:"username",style:{color:t?"#5865F2":"#F2F3F5"},children:i.sender?.username||i.author||"User"}),e.jsx("span",{className:"timestamp",children:p(i.timestamp)})]}),(i.fileType==="text"||!i.fileType||i.fileType==="none")&&i.text&&e.jsx("div",{className:"text-content",style:{textAlign:t?"right":"left"},children:i.text}),i.fileType==="video"&&d&&e.jsx("div",{className:"media-content",children:e.jsx("video",{controls:!0,src:d})}),i.fileType==="image"&&d&&e.jsx("div",{className:"media-content",children:e.jsx("img",{src:d,alt:"uploaded content",style:{maxWidth:"100%",borderRadius:"8px"}})}),i.fileType==="voice"&&d&&e.jsx("div",{className:"media-content",children:e.jsx("audio",{controls:!0,src:d})})]})]})};function X({onClose:i,currentUser:t}){const[m,d]=a.useState([]),[p,f]=a.useState(""),[g,F]=a.useState(!1),[z,k]=a.useState(!1),[j,C]=a.useState(""),[T,h]=a.useState(""),[u,W]=a.useState([]),[M,y]=a.useState(!1),I=a.useRef(null),D=a.useRef(null),b=a.useRef(null),w=a.useRef([]),B=a.useCallback(()=>{I.current?.scrollIntoView({behavior:"smooth"})},[]),c=a.useCallback(async()=>{try{const s=await L();s.sort((n,l)=>n.timestamp-l.timestamp),d(s)}catch(s){console.error("Failed to load messages",s)}},[]),v=a.useCallback(async()=>{if(t)try{const s=await _(t.id),n=await Promise.all(s.map(async l=>{const r=await K(l.fromUserId);return{...l,senderName:r?.username||"Unknown",senderPasscode:r?.passcode}}));W(n)}catch(s){console.error("Failed to load requests",s)}},[t]);a.useEffect(()=>{c(),v();const s=setInterval(()=>{c(),v()},5e3);return()=>clearInterval(s)},[c,v]),a.useEffect(()=>{B()},[m,B]);const E=async()=>{if(!p.trim())return;const s={text:p,sender:t.id,channel:"general",fileType:"text"};try{await N(s),f(""),c()}catch(n){console.error("Failed to send text",n)}},V=s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),E())},q=async()=>{if(j.trim()){h("Searching...");try{const s=await Z(j.trim());if(!s){h("âŒ User not found.");return}if(s.id===t.id){h("âŒ That's you!");return}await O(t.id,s.id),h(`âœ… Request sent to ${s.username}!`),C("")}catch(s){console.error(s),h("âŒ Failed to send request.")}}},P=async s=>{try{await Y(s),v(),alert("Friend added!")}catch(n){console.error(n)}},A=async s=>{const n=s.target.files[0];if(!n)return;const l=n.type.startsWith("video/"),r=n.type.startsWith("image/");if(!l&&!r){alert("Only video and image files are supported.");return}const o=new FormData;o.append("file",n),o.append("sender",t.id),o.append("channel","general"),o.append("fileType",l?"video":"image");try{await N(o),c()}catch(R){console.error("Failed to upload file",R)}s.target.value=null},H=async()=>{try{const s=await navigator.mediaDevices.getUserMedia({audio:!0});let n="";typeof MediaRecorder.isTypeSupported=="function"&&(MediaRecorder.isTypeSupported("audio/mp4")?n="audio/mp4":MediaRecorder.isTypeSupported("audio/aac")?n="audio/aac":MediaRecorder.isTypeSupported("audio/webm;codecs=opus")?n="audio/webm;codecs=opus":MediaRecorder.isTypeSupported("audio/webm")&&(n="audio/webm"));const l=n?{mimeType:n}:void 0,r=new MediaRecorder(s,l);b.current=r,w.current=[],r.ondataavailable=o=>{o.data.size>0&&w.current.push(o.data)},r.onstop=async()=>{const o=r.mimeType||n||"audio/webm",R=new Blob(w.current,{type:o}),x=new FormData;x.append("file",R,"voice_message.webm"),x.append("sender",t.id),x.append("channel","general"),x.append("fileType","voice");try{await N(x),c()}catch(S){console.error("Failed to send voice message",S)}s.getTracks().forEach(S=>S.stop())},r.start(),F(!0)}catch(s){console.error("Failed to access microphone",s),alert("Could not access microphone.")}},$=()=>{b.current&&g&&(b.current.stop(),F(!1))},U=()=>{g?$():H()};return t?e.jsxs("div",{className:"app-container",children:[z&&e.jsx("div",{className:"mobile-overlay open",style:{display:"flex",alignItems:"center",justifyContent:"center",pointerEvents:"auto"},children:e.jsxs("div",{className:"glass-panel",style:{width:"90%",maxWidth:"400px",position:"relative"},children:[e.jsx("button",{onClick:()=>k(!1),style:{position:"absolute",top:"10px",right:"10px",background:"none",border:"none",color:"white",fontSize:"1.5rem",cursor:"pointer"},children:"âœ•"}),e.jsx("h2",{style:{marginBottom:"1rem",color:"white"},children:"Manage Friends"}),e.jsxs("div",{style:{marginBottom:"2rem"},children:[e.jsx("p",{style:{color:"#ccc",fontSize:"0.9rem",marginBottom:"0.5rem"},children:"Add Friend by Username or Passcode"}),e.jsxs("div",{style:{display:"flex",gap:"8px"},children:[e.jsx("input",{type:"text",className:"input-field",style:{margin:0},placeholder:"Username or Passcode...",value:j,onChange:s=>C(s.target.value)}),e.jsx("button",{className:"btn-primary",style:{width:"auto"},onClick:q,children:"Send"})]}),T&&e.jsx("p",{style:{marginTop:"0.5rem",fontSize:"0.9rem",color:"#ddd"},children:T})]}),e.jsxs("div",{style:{borderTop:"1px solid rgba(255,255,255,0.1)",paddingTop:"1rem"},children:[e.jsxs("h3",{style:{fontSize:"1rem",color:"#ccc",marginBottom:"0.5rem"},children:["Pending Requests (",u.length,")"]}),u.length===0&&e.jsx("p",{style:{color:"#666",fontSize:"0.8rem"},children:"No pending requests."}),e.jsx("ul",{style:{listStyle:"none",padding:0},children:u.map(s=>e.jsxs("li",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",background:"rgba(0,0,0,0.2)",padding:"8px",marginBottom:"4px",borderRadius:"4px"},children:[e.jsxs("div",{style:{color:"white"},children:[e.jsx("span",{style:{fontWeight:"bold"},children:s.senderName}),e.jsxs("span",{style:{fontSize:"0.8rem",color:"#aaa"},children:[" #",s.senderPasscode]})]}),e.jsx("button",{onClick:()=>P(s.id),style:{background:"#2ecc71",border:"none",color:"white",padding:"4px 8px",borderRadius:"4px",cursor:"pointer"},children:"Accept"})]},s.id))})]})]})}),e.jsx("div",{className:`mobile-overlay ${M?"open":""}`,onClick:()=>y(!1)}),e.jsxs("div",{className:`sidebar-wrapper ${M?"open":""}`,children:[e.jsxs("nav",{className:"server-sidebar",children:[e.jsx("div",{className:"server-icon active",children:"D"}),e.jsx("div",{className:"server-divider"}),e.jsx("div",{className:"server-icon"}),e.jsx("div",{className:"server-icon"})]}),e.jsxs("div",{className:"channel-sidebar",children:[e.jsx("header",{className:"chat-header",style:{boxShadow:"none"},children:e.jsx("span",{style:{fontWeight:"bold"},children:"Disclone Server"})}),e.jsxs("div",{style:{flex:1,padding:"8px",overflowY:"auto"},children:[e.jsx("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:"8px"},children:e.jsx("span",{style:{textTransform:"uppercase",fontSize:"12px",fontWeight:"bold",color:"#949BA4",paddingLeft:"8px"},children:"Channels"})}),e.jsxs("div",{style:{display:"flex",alignItems:"center",padding:"6px 8px",borderRadius:"4px",background:"rgba(255,255,255,0.08)",marginBottom:"4px",color:"#fff",cursor:"pointer"},onClick:()=>y(!1),children:[e.jsx("span",{style:{color:"#80848E",marginRight:"6px",fontSize:"20px"},children:"#"}),e.jsx("span",{style:{fontWeight:500},children:"general"})]}),e.jsx("div",{style:{marginTop:"24px"},children:e.jsxs("button",{onClick:()=>{k(!0),y(!1)},style:{width:"100%",background:"#248046",border:"none",color:"white",padding:"8px",borderRadius:"4px",cursor:"pointer",fontWeight:"bold",display:"flex",alignItems:"center",justifyContent:"center",gap:"8px"},children:[e.jsx("span",{style:{fontSize:"1.2rem"},children:"ðŸ‘‹"})," Manage Friends",u.length>0&&e.jsx("span",{style:{background:"#ED4245",padding:"2px 6px",borderRadius:"10px",fontSize:"12px"},children:u.length})]})})]}),e.jsxs("div",{style:{backgroundColor:"#232428",padding:"10px 8px",display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",minWidth:0},children:[e.jsx("div",{style:{width:"32px",height:"32px",borderRadius:"50%",background:"#F0B132",flexShrink:0}}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",minWidth:0},children:[e.jsx("span",{style:{fontSize:"14px",fontWeight:"600",lineHeight:"18px",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:t.username}),e.jsxs("span",{style:{fontSize:"12px",color:"#DBDEE1"},children:["#",t.passcode]})]})]}),e.jsx("button",{onClick:i,title:"Fully Close Website",style:{background:"#ED4245",border:"none",color:"white",width:"32px",height:"32px",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",fontWeight:"bold",flexShrink:0},children:"âœ•"})]})]})]}),e.jsxs("main",{className:"chat-area",children:[e.jsxs("header",{className:"chat-header",children:[e.jsx("button",{className:"menu-btn",onClick:()=>y(!0),"aria-label":"Open Menu",children:e.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M3 8V6H21V8H3ZM3 13H21V11H3V13ZM3 18H21V16H3V18Z"})})}),e.jsx("span",{style:{fontSize:"24px",color:"#80848E",marginRight:"8px",fontWeight:300},children:"#"}),e.jsx("span",{style:{fontWeight:"bold",color:"#F2F3F5"},children:"general"}),e.jsx("button",{className:"mobile-close-btn",onClick:i,title:"Close Session",children:"âœ•"})]}),e.jsxs("div",{className:"message-list",children:[e.jsxs("div",{className:"message-item",children:[e.jsx("div",{className:"avatar",style:{background:"#5865F2"}}),e.jsxs("div",{className:"message-content",children:[e.jsx("div",{className:"message-header",children:e.jsx("span",{className:"username",children:"System"})}),e.jsx("div",{className:"text-content",children:"Welcome to your secure Disclone instance. Messages are saved locally."})]})]}),m.map(s=>e.jsx(J,{msg:s,isOwnMessage:s.authorId===t.id},s.id)),e.jsx("div",{ref:I})]}),e.jsxs("div",{className:"chat-input-container",children:[e.jsx("input",{type:"file",accept:"video/*,image/*",style:{display:"none"},ref:D,onChange:A}),e.jsx("button",{className:"icon-btn",onClick:()=>D.current.click(),title:"Upload File",children:e.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"})})}),e.jsx("input",{type:"text",className:"chat-input",placeholder:`Message #general as ${t.username}`,value:p,onChange:s=>f(s.target.value),onKeyDown:V}),e.jsx("button",{className:`icon-btn ${g?"recording":""}`,onClick:U,title:g?"Stop Recording":"Record Voice Message",children:e.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:[e.jsx("path",{d:"M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"}),e.jsx("path",{d:"M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"})]})})]})]})]}):null}export{X as default};
