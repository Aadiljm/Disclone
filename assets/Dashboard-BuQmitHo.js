import{r,j as e}from"./index-Dd64enzj.js";const B="DiscloneDB",h="messages",I=1,w=()=>new Promise((t,n)=>{const c=indexedDB.open(B,I);c.onerror=a=>n(a.target.error),c.onupgradeneeded=a=>{const i=a.target.result;i.objectStoreNames.contains(h)||i.createObjectStore(h,{keyPath:"id"})},c.onsuccess=a=>t(a.target.result)}),y=async t=>{const n=await w();return new Promise((c,a)=>{const u=n.transaction([h],"readwrite").objectStore(h).add(t);u.onsuccess=()=>c(u.result),u.onerror=m=>a(m.target.error)})},V=async()=>{const t=await w();return new Promise((n,c)=>{const l=t.transaction([h],"readonly").objectStore(h).getAll();l.onsuccess=()=>n(l.result),l.onerror=u=>c(u.target.error)})},F=({msg:t})=>{const[n,c]=r.useState(null);r.useEffect(()=>{if(t.type==="video"||t.type==="voice"||t.type==="image"){const i=URL.createObjectURL(t.content);return c(i),()=>URL.revokeObjectURL(i)}},[t]);const a=i=>new Date(i).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return e.jsxs("div",{className:"message-item",children:[e.jsx("div",{className:"avatar"}),e.jsxs("div",{className:"message-content",children:[e.jsxs("div",{className:"message-header",children:[e.jsx("span",{className:"username",children:"User"}),e.jsx("span",{className:"timestamp",children:a(t.timestamp)})]}),t.type==="text"&&e.jsx("div",{className:"text-content",children:t.content}),t.type==="video"&&n&&e.jsx("div",{className:"media-content",children:e.jsx("video",{controls:!0,src:n})}),t.type==="image"&&n&&e.jsx("div",{className:"media-content",children:e.jsx("img",{src:n,alt:"uploaded content",style:{maxWidth:"100%",borderRadius:"8px"}})}),t.type==="voice"&&n&&e.jsx("div",{className:"media-content",children:e.jsx("audio",{controls:!0,src:n})})]})]})};function z({onClose:t}){const[n,c]=r.useState([]),[a,i]=r.useState(""),[l,u]=r.useState(!1),[m,x]=r.useState(!1),b=r.useRef(null),N=r.useRef(null),g=r.useRef(null),v=r.useRef([]),R=r.useCallback(()=>{b.current?.scrollIntoView({behavior:"smooth"})},[]),p=r.useCallback(async()=>{try{const s=await V();s.sort((o,d)=>o.timestamp-d.timestamp),c(s)}catch(s){console.error("Failed to load messages",s)}},[]);r.useEffect(()=>{p()},[p]),r.useEffect(()=>{R()},[n,R]);const D=async()=>{if(!a.trim())return;const s={id:crypto.randomUUID(),type:"text",content:a,timestamp:Date.now()};try{await y(s),i(""),p()}catch(o){console.error("Failed to send text",o)}},S=s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),D())},M=async s=>{const o=s.target.files[0];if(!o)return;const d=o.type.startsWith("video/"),j=o.type.startsWith("image/");if(!d&&!j){alert("Only video and image files are supported.");return}const f={id:crypto.randomUUID(),type:d?"video":"image",content:o,timestamp:Date.now()};try{await y(f),p()}catch(U){console.error("Failed to upload file",U)}s.target.value=null},C=async()=>{try{const s=await navigator.mediaDevices.getUserMedia({audio:!0}),o=new MediaRecorder(s);g.current=o,v.current=[],o.ondataavailable=d=>{d.data.size>0&&v.current.push(d.data)},o.onstop=async()=>{const d=new Blob(v.current,{type:"audio/webm"}),j={id:crypto.randomUUID(),type:"voice",content:d,timestamp:Date.now()};await y(j),p(),s.getTracks().forEach(f=>f.stop())},o.start(),u(!0)}catch(s){console.error("Scale to access microphone",s),alert("Could not access microphone.")}},k=()=>{g.current&&l&&(g.current.stop(),u(!1))},E=()=>{l?k():C()};return e.jsxs("div",{className:"app-container",children:[e.jsx("div",{className:`mobile-overlay ${m?"open":""}`,onClick:()=>x(!1)}),e.jsxs("div",{className:`sidebar-wrapper ${m?"open":""}`,children:[e.jsxs("nav",{className:"server-sidebar",children:[e.jsx("div",{className:"server-icon active",children:"D"}),e.jsx("div",{className:"server-divider"}),e.jsx("div",{className:"server-icon"}),e.jsx("div",{className:"server-icon"})]}),e.jsxs("div",{className:"channel-sidebar",children:[e.jsx("header",{className:"chat-header",style:{boxShadow:"none"},children:e.jsx("span",{style:{fontWeight:"bold"},children:"Disclone Server"})}),e.jsx("div",{style:{flex:1,padding:"8px",overflowY:"auto"},children:e.jsxs("div",{style:{display:"flex",alignItems:"center",padding:"6px 8px",borderRadius:"4px",background:"rgba(255,255,255,0.08)",marginBottom:"4px",color:"#fff",cursor:"pointer"},onClick:()=>x(!1),children:[e.jsx("span",{style:{color:"#80848E",marginRight:"6px",fontSize:"20px"},children:"#"}),e.jsx("span",{style:{fontWeight:500},children:"general"})]})}),e.jsxs("div",{style:{backgroundColor:"#232428",padding:"10px 8px",display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsx("div",{style:{width:"32px",height:"32px",borderRadius:"50%",background:"#F0B132"}}),e.jsxs("div",{style:{display:"flex",flexDirection:"column"},children:[e.jsx("span",{style:{fontSize:"14px",fontWeight:"600",lineHeight:"18px"},children:"Guest"}),e.jsx("span",{style:{fontSize:"12px",color:"#DBDEE1"},children:"#9999"})]})]}),e.jsx("button",{onClick:t,title:"Fully Close Website",style:{background:"#ED4245",border:"none",color:"white",width:"32px",height:"32px",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",fontWeight:"bold"},children:"✕"})]})]})]}),e.jsxs("main",{className:"chat-area",children:[e.jsxs("header",{className:"chat-header",children:[e.jsx("button",{className:"menu-btn",onClick:()=>x(!0),"aria-label":"Open Menu",children:e.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M3 8V6H21V8H3ZM3 13H21V11H3V13ZM3 18H21V16H3V18Z"})})}),e.jsx("span",{style:{fontSize:"24px",color:"#80848E",marginRight:"8px",fontWeight:300},children:"#"}),e.jsx("span",{style:{fontWeight:"bold",color:"#F2F3F5"},children:"general"}),e.jsx("button",{className:"mobile-close-btn",onClick:t,title:"Close Session",children:"✕"})]}),e.jsxs("div",{className:"message-list",children:[e.jsxs("div",{className:"message-item",children:[e.jsx("div",{className:"avatar",style:{background:"#5865F2"}}),e.jsxs("div",{className:"message-content",children:[e.jsx("div",{className:"message-header",children:e.jsx("span",{className:"username",children:"System"})}),e.jsx("div",{className:"text-content",children:"Welcome to your secure Disclone instance. Messages are saved locally."})]})]}),n.map(s=>e.jsx(F,{msg:s},s.id)),e.jsx("div",{ref:b})]}),e.jsxs("div",{className:"chat-input-container",children:[e.jsx("input",{type:"file",accept:"video/*,image/*",style:{display:"none"},ref:N,onChange:M}),e.jsx("button",{className:"icon-btn",onClick:()=>N.current.click(),title:"Upload File",children:e.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"})})}),e.jsx("input",{type:"text",className:"chat-input",placeholder:"Message #general",value:a,onChange:s=>i(s.target.value),onKeyDown:S}),e.jsx("button",{className:`icon-btn ${l?"recording":""}`,onClick:E,title:l?"Stop Recording":"Record Voice Message",children:e.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:[e.jsx("path",{d:"M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"}),e.jsx("path",{d:"M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"})]})})]})]})]})}export{z as default};
